
# Monte-Carlo 模拟程序说明（简要）

本目录下的 `Monte-Carlo_1-2_demo.py` 是用于重建并估算粉丝投票排名（fan rank）分布的蒙特卡罗风格枚举模拟脚本。脚本基于历史评委打分和已知的历史淘汰者，反推可能的粉丝排名排列，从而估计每位选手成为粉丝第一（fan favorite）的概率及粉丝排名的均值/标准差。

## 程序主要工作流程

1. 读取数据文件 `2026_MCM_Problem_C_Data.csv`（包含赛季、选手、每周评委分数、以及结果等列）。
2. 数据清洗：把无法解析的分数（如 N/A）转换为数值 0（或 NaN 再填 0）。
3. 对每个指定的赛季与周（脚本中以 `target_seasons = [1,2]` 为例）：
   - 计算当周每位选手的评委总分（4 位评委之和）。
   - 筛选“仍在比赛”的选手（当周评委总分 > 0）。
   - 找到历史记录中该周实际被淘汰的选手（`results` 列包含 `Eliminated Week X`）。
   - 为该周的活跃选手计算评委排名（Judge Rank）：分数高者排名靠前（1 为最高）。
   - 枚举粉丝排名的所有可能排列（fan ranks 为 1..N 的全排列），对每一种排列：
	   - 计算总排名 = Judge Rank + Fan Rank
	   - 如果历史上实际被淘汰者出现在总排名最大（并列也视为符合）的选手中，则把这次排列记为“有效”（符合历史淘汰结果）。
   - 对所有有效排列，统计每位选手的粉丝排名（fan rank）的均值、标准差，以及成为粉丝第1 的频率。

注：当选手人数较大时，N! 增长迅速，脚本支持传入 `iterations` 限制枚举数量以加速调试（示例默认枚举全部排列，但对现实数据常常需要限制或改用采样）。

## 代码里主要函数说明

- `get_judge_ranks(scores)`：把分数列表转换成排名（分数高 -> Rank 1）。脚本里对并列做了简化处理（使用 argsort 两次生成唯一排名）。
- `run_simulation(season_num, week_num, df, iterations=None)`：核心模拟函数，返回一个 DataFrame，列出该周每位活跃选手在符合历史淘汰结果的排列集合下估算的粉丝排名统计量。
- `get_available_weeks(df)`：从列名中自动识别数据包含的周数（如 `week3_judge1_score`）。
- `count_active_dancers(season_num, week_num, df)`：统计某赛季某周还在比赛（当周评委总分 > 0）的选手数。

## 输出说明

脚本会把所有赛季/周的估算结果合并成 `final_report` 并导出为 CSV（`monte_carlo_results.csv`）。每行代表一次“赛季+周+选手”的估算统计，字段含义如下：

- `Season`：赛季编号（整数）。
- `Week`：周编号（整数）。
- `Name`：选手姓名（`celebrity_name` 列）。
- `Judge_Score`：该周评委打分总和（四位评委得分之和）。
- `Judge_Rank`：仅根据评委分数计算出的评委排名（1 为最高分）。
- `Est_Fan_Rank_Mean`：在所有“符合历史淘汰结果”的粉丝排名排列中，该选手的粉丝排名（fan rank）的平均值（近似估计）。
- `Est_Fan_Rank_Std`：粉丝排名的标准差（反映不确定性）。
- `Prob_Fan_Favorite`：该选手在有效排列中成为粉丝第一（fan rank == 1）的百分比（以百分比表示，如 23.4 表示 23.4%）。
- `Actual_Result`：历史上该选手在该周的真实结果（若该行对应的选手就是该周被淘汰者则为 `Eliminated`，否则 `Safe`）。

脚本在控制台也会打印一些汇总信息，例如：检查过的排列数量、符合历史淘汰的有效排列数等。若某周没有有效排列（可能模型假设过严或枚举次数不足），会给出警告并跳过该周。

## 注意事项与限制

- 并列排名（tie）在真实规则中可能有专门的处理（如按评委分数再决胜），脚本在排名与判定上做了简化，直接把并列情况按唯一名次处理或视为符合条件（若并列导致多人并列最大总排名，会计为有效）。
- 全排列枚举在选手人数较多时不可行（计算和内存爆炸），实际使用时可改为随机采样（抽样排列）或改用概率模型来估计粉丝排名分布。
- 输出的统计量是基于“与历史淘汰结果一致的粉丝排名排列集合”的条件分布，不代表粉丝真实投票分布的无条件估计，而是受模型假设（总排名 = 评委排名 + 粉丝排名）强烈约束的反演结果。

